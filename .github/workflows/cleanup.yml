name: Cleanup Old Images

on:
  schedule:
    # Run daily at 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  REGISTRY: ${{ secrets.CONTAINER_REGISTRY }}
  RETENTION_COUNT: 10

jobs:
  cleanup-docker-hub:
    runs-on: ubuntu-latest
    if: ${{ vars.USE_ECR != 'true' }}
    strategy:
      matrix:
        image:
          - backend
          - credibility-analyzer
          - ml-service
          - ml-service-gpu
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Delete old Docker Hub images
        uses: vlaurin/action-ghcr-prune@v0.6.0
        with:
          token: ${{ secrets.DOCKERHUB_TOKEN }}
          organization: ${{ secrets.DOCKERHUB_USERNAME }}
          container: ${{ matrix.image }}
          keep-last: ${{ env.RETENTION_COUNT }}
          prune-untagged: true
          dry-run: false

  cleanup-ecr:
    runs-on: ubuntu-latest
    if: ${{ vars.USE_ECR == 'true' }}
    strategy:
      matrix:
        image:
          - backend
          - credibility-analyzer
          - ml-service
          - ml-service-gpu
    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Get image tags to delete
        id: get-tags
        run: |
          # Get all image tags sorted by push date (oldest first)
          TAGS=$(aws ecr describe-images \
            --repository-name ${{ matrix.image }} \
            --query 'sort_by(imageDetails,& imagePushedAt)[*].imageTags[0]' \
            --output text)
          
          # Count total tags
          TOTAL=$(echo "$TAGS" | wc -w)
          
          # Calculate how many to delete (keep last RETENTION_COUNT)
          DELETE_COUNT=$((TOTAL - ${{ env.RETENTION_COUNT }}))
          
          if [ $DELETE_COUNT -gt 0 ]; then
            # Get tags to delete (oldest ones)
            DELETE_TAGS=$(echo "$TAGS" | tr ' ' '\n' | head -n $DELETE_COUNT | tr '\n' ' ')
            echo "tags_to_delete=$DELETE_TAGS" >> $GITHUB_OUTPUT
            echo "has_tags_to_delete=true" >> $GITHUB_OUTPUT
          else
            echo "has_tags_to_delete=false" >> $GITHUB_OUTPUT
          fi

      - name: Delete old ECR images
        if: steps.get-tags.outputs.has_tags_to_delete == 'true'
        run: |
          for TAG in ${{ steps.get-tags.outputs.tags_to_delete }}; do
            echo "Deleting ${{ matrix.image }}:$TAG"
            aws ecr batch-delete-image \
              --repository-name ${{ matrix.image }} \
              --image-ids imageTag=$TAG || true
          done

      - name: Delete untagged images
        run: |
          # Get untagged image digests
          UNTAGGED=$(aws ecr describe-images \
            --repository-name ${{ matrix.image }} \
            --filter "tagStatus=UNTAGGED" \
            --query 'imageDetails[*].imageDigest' \
            --output text)
          
          if [ -n "$UNTAGGED" ]; then
            for DIGEST in $UNTAGGED; do
              echo "Deleting untagged image: $DIGEST"
              aws ecr batch-delete-image \
                --repository-name ${{ matrix.image }} \
                --image-ids imageDigest=$DIGEST || true
            done
          fi
